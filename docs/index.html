<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Quantum Framework Popularity</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <!-- Quick-n-nice font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    />
    <style>
      body {
        font-family: Inter, system-ui, sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col">
    <header class="bg-white shadow p-6 mb-8">
      <h1 class="text-3xl font-semibold text-center">
        Quantum Framework Popularity
      </h1>
      <p class="text-center text-gray-500 mt-2" id="generated"></p>
    </header>

    <main class="flex-grow container mx-auto px-4">
      <div class="overflow-x-auto">
        <table
          id="tbl"
          class="min-w-full text-sm text-left bg-white shadow-md rounded-lg"
        >
          <thead
            class="text-xs uppercase bg-gray-100 text-gray-700 select-none"
          >
            <tr>
              <th class="px-4 py-3 cursor-pointer">Framework</th>
              <th class="px-4 py-3 cursor-pointer">Stars</th>
              <th class="px-4 py-3 cursor-pointer">Commits</th>
              <th class="px-4 py-3 cursor-pointer">Forks</th>
              <th class="px-4 py-3 cursor-pointer">Watchers</th>
              <th class="px-4 py-3">Company</th>
              <th class="px-4 py-3">Language</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </main>

    <footer class="text-center text-xs text-gray-400 py-6">
      Built with ❤️ + GitHub Actions – source on
      <a
        href="https://github.com/splch/quantum-framework-popularity"
        class="underline"
        >GitHub</a
      >
    </footer>

    <script>
      (async () => {
        const { history } = await fetch("data/metrics.json", {
          cache: "no-store",
        }).then((r) => r.json());

        /* helpers */
        const last = history.at(-1);
        const dates = history.map((h) => new Date(h.generated_at));
        const latest = Object.fromEntries(
          last.frameworks.map((f) => [f.repo, f])
        );

        const tbody = document.getElementById("rows");
        const genEl = document.getElementById("generated");
        genEl.textContent = `Latest snapshot: ${dates.at(-1).toLocaleString()}`;

        const numericCols = ["stars", "commits", "forks", "watchers"];
        function sortValue(td) {
          const n = td.textContent.replace(/[^0-9.-]/g, "");
          return n && !isNaN(+n) ? +n : td.textContent.toLowerCase();
        }

        /* build table */
        for (const fw of Object.values(latest)) {
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-50";
          tr.innerHTML = `
              <td class="px-4 py-2 font-medium"><a href="https://github.com/${
                fw.repo
              }" target="_blank" class="text-blue-600 hover:underline">${
            fw.name
          }</a></td>
              <td class="px-4 py-2 metric" data-repo="${
                fw.repo
              }" data-field="stars">${fw.stars.toLocaleString()}</td>
              <td class="px-4 py-2 metric" data-repo="${
                fw.repo
              }" data-field="commits">${fw.commits.toLocaleString()}</td>
              <td class="px-4 py-2 metric" data-repo="${
                fw.repo
              }" data-field="forks">${fw.forks.toLocaleString()}</td>
              <td class="px-4 py-2 metric" data-repo="${
                fw.repo
              }" data-field="watchers">${fw.watchers.toLocaleString()}</td>
              <td class="px-4 py-2">${fw.company || ""}</td>
              <td class="px-4 py-2">${fw.language || ""}</td>`;
          tbody.appendChild(tr);
        }

        /* column sort */
        document.querySelectorAll("th.cursor-pointer").forEach((th, i) => {
          let dir = 1;
          th.addEventListener("click", () => {
            dir *= -1;
            [...tbody.rows]
              .sort((a, b) => {
                const A = sortValue(a.cells[i]),
                  B = sortValue(b.cells[i]);
                if (typeof A === "number" && typeof B === "number")
                  return dir * (A - B);
                return dir * A.localeCompare(B);
              })
              .forEach((tr) => tbody.appendChild(tr));
          });
        });

        /* metric‑click → chart */
        const modal = document.getElementById("modal");
        const close = document.getElementById("close");
        const ctx = document.getElementById("chart");
        let chart = null;

        function series(repo, field) {
          return history.map((snap) => {
            const f = snap.frameworks.find((x) => x.repo === repo);
            return f ? f[field] : null;
          });
        }

        tbody.addEventListener("click", (e) => {
          const cell = e.target.closest(".metric");
          if (!cell) return;
          const repo = cell.dataset.repo;
          const field = cell.dataset.field;
          const fw = latest[repo];

          /* data & labels */
          const data = series(repo, field);
          const label = `${fw.name} – ${field}`;

          /* (re)draw */
          chart && chart.destroy();
          chart = new Chart(ctx, {
            type: "line",
            data: {
              labels: dates.map((d) => d.toLocaleDateString()),
              datasets: [{ label, data, fill: false, tension: 0.2 }],
            },
            options: { plugins: { legend: { display: false } } },
          });
          document.getElementById("modal-title").textContent = label;
          modal.classList.remove("hidden", "opacity-0");
        });

        close.addEventListener("click", () => modal.classList.add("hidden"));
      })();
    </script>
    <div
      id="modal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center"
    >
      <div class="bg-white rounded-lg p-4 max-w-lg w-full shadow-lg">
        <button id="close" class="float-right text-gray-400 hover:text-black">
          ✕
        </button>
        <h2 id="modal-title" class="text-lg font-semibold mb-2"></h2>
        <canvas id="chart" class="w-full h-64"></canvas>
      </div>
    </div>
  </body>
</html>
