<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Quantum Framework Popularity</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <!-- Quick-n-nice font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    />
    <style>
      body {
        font-family: Inter, system-ui, sans-serif;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col">
    <header class="bg-white shadow p-6 mb-8">
      <h1 class="text-3xl font-semibold text-center">
        Quantum Framework Popularity
      </h1>
      <p id="generated" class="text-center text-gray-500 mt-2"></p>
    </header>

    <main class="flex-grow container mx-auto px-4">
      <div class="overflow-x-auto">
        <table
          id="tbl"
          class="min-w-full text-sm text-left bg-white shadow-md rounded-lg"
        >
          <thead
            class="text-xs uppercase bg-gray-100 text-gray-700 select-none"
          >
            <tr>
              <th class="px-4 py-3 cursor-pointer">Framework</th>
              <th class="px-4 py-3 cursor-pointer">Stars</th>
              <th class="px-4 py-3 cursor-pointer">Commits</th>
              <th class="px-4 py-3 cursor-pointer">Forks</th>
              <th class="px-4 py-3 cursor-pointer">Watchers</th>
              <th class="px-4 py-3">Company</th>
              <th class="px-4 py-3">Language</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </main>

    <footer class="text-center text-xs text-gray-400 py-6">
      Built with ❤️ + GitHub Actions – source on
      <a
        href="https://github.com/splch/quantum-framework-popularity"
        class="underline"
        target="_blank"
        >GitHub</a
      >
    </footer>

    <!-- Quick modal for metric trendlines -->
    <div
      id="modal"
      class="fixed inset-0 bg-black/50 hidden items-center justify-center"
    >
      <div class="bg-white rounded-lg p-4 max-w-lg w-full shadow-lg">
        <button id="close" class="float-right text-gray-400 hover:text-black">
          ✕
        </button>
        <h2 id="modal-title" class="text-lg font-semibold mb-2"></h2>
        <canvas id="chart" class="w-full h-64"></canvas>
      </div>
    </div>

    <script>
      (async () => {
        const { history } = await fetch("data/metrics.json", {
          cache: "no-store",
        }).then((r) => r.json());

        /* helpers */
        const last = history.at(-1);
        const dates = history.map((h) => new Date(h.generated_at));
        const latest = Object.fromEntries(
          last.frameworks.map((f) => [f.repo, f])
        );

        document.getElementById(
          "generated"
        ).textContent = `Latest snapshot: ${dates.at(-1).toLocaleString()}`;

        const tbody = document.getElementById("rows");
        const rowsTmp = []; // we will sort before appending

        // Build <tr> for each framework
        for (const fw of Object.values(latest)) {
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-50";
          tr.innerHTML = `
            <td class="px-4 py-2 font-medium"><a href="https://github.com/${
              fw.repo
            }" target="_blank" class="text-blue-600 hover:underline">${
            fw.name
          }</a></td>
              <td class="px-4 py-2 metric" data-repo="${
                fw.repo
              }" data-field="stars">${fw.stars.toLocaleString()}</td>
              <td class="px-4 py-2 metric" data-repo="${
                fw.repo
              }" data-field="commits">${fw.commits.toLocaleString()}</td>
              <td class="px-4 py-2 metric" data-repo="${
                fw.repo
              }" data-field="forks">${fw.forks.toLocaleString()}</td>
              <td class="px-4 py-2 metric" data-repo="${
                fw.repo
              }" data-field="watchers">${fw.watchers.toLocaleString()}</td>
            <td class="px-4 py-2">${fw.company || ""}</td>
            <td class="px-4 py-2">${fw.language || ""}</td>`;
          rowsTmp.push(tr);
        }

        // default sort: by stars DESC
        rowsTmp.sort((a, b) => {
          const A = parseInt(a.cells[1].textContent.replace(/,/g, ""), 10);
          const B = parseInt(b.cells[1].textContent.replace(/,/g, ""), 10);
          return B - A; // descending
        });
        rowsTmp.forEach((tr) => tbody.appendChild(tr));

        // column‑click sorting (numeric aware)
        function sortValue(td) {
          const raw = td.textContent.trim();
          const num = raw.replace(/[^0-9.-]/g, "");
          return num && !isNaN(+num) ? +num : raw.toLowerCase();
        }
        document.querySelectorAll("th.cursor-pointer").forEach((th, colIdx) => {
          let dir = 1;
          th.addEventListener("click", () => {
            dir *= -1;
            [...tbody.rows]
              .sort((a, b) => {
                const A = sortValue(a.cells[colIdx]);
                const B = sortValue(b.cells[colIdx]);
                if (typeof A === "number" && typeof B === "number")
                  return dir * (A - B);
                return dir * A.localeCompare(B);
              })
              .forEach((tr) => tbody.appendChild(tr));
          });
        });

        /* metric‑click → sparkline */
        const modal = document.getElementById("modal");
        const close = document.getElementById("close");
        const ctx = document.getElementById("chart");
        let chartRef = null;

        function series(repo, field) {
          return history.map(
            (s) => (s.frameworks.find((f) => f.repo === repo) || {})[field]
          );
        }

        tbody.addEventListener("click", (e) => {
          const cell = e.target.closest(".metric");
          if (!cell) return;
          const repo = cell.dataset.repo;
          const field = cell.dataset.field;
          const fw = latest[repo];

          /* (re)draw */
          chartRef && chartRef.destroy();
          chartRef = new Chart(ctx, {
            type: "line",
            data: {
              labels: dates.map((d) => d.toLocaleDateString()),
              datasets: [
                { data: series(repo, field), fill: false, tension: 0.2 },
              ],
            },
            options: { plugins: { legend: { display: false } } },
          });
          document.getElementById(
            "modal-title"
          ).textContent = `${fw.name} - ${field}`;
          modal.classList.remove("hidden");
        });

        close.addEventListener("click", () => modal.classList.add("hidden"));
      })();
    </script>
  </body>
</html>
